name: Supabase Heartbeat Backup

on:
  schedule:
    # Run 6 hours after primary heartbeat (9:00 AM UTC) as backup
    - cron: '0 15 * * *'
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    
    steps:
    - name: Execute Supabase Heartbeat
      run: |
        echo "Starting backup heartbeat at $(date -u)"
        
        # Make a lightweight request to Supabase REST API
        response=$(curl -s -w "%{http_code}" -X GET \
          "${{ secrets.SUPABASE_URL }}/rest/v1/settings?select=updated_at&limit=1" \
          -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
          -H "Content-Type: application/json")
        
        http_code="${response: -3}"
        body="${response%???}"
        
        echo "HTTP Status: $http_code"
        echo "Response Body: $body"
        
        if [ "$http_code" -ne 200 ]; then
          echo "Heartbeat failed with HTTP code: $http_code"
          exit 1
        fi
        
        echo "Backup heartbeat completed successfully"
      
    - name: Log Heartbeat Result
      run: |
        echo "Backup heartbeat executed successfully at $(date -u)"
        
    - name: Notify on Failure
      if: failure()
      run: |
        echo "⚠️ Supabase backup heartbeat failed at $(date -u)"
        echo "Please check the primary Netlify heartbeat function"
        echo "Manual activation may be required if both fail"